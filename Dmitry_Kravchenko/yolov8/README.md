# Отчет о выполненной работе по стажировке "Создание системы распознавания взрывоопасных предметов для перегружателей металлического лома (ООО «ПМХ-Втормет»)"

<img src="07_ANPR_demonstration/materials/image3.png" width="1200"> 

## Цель
 
Проект заключается в разработке системы компьютерного зрения и object detection для установки на перегружатель лома. Система должна выявлять визуально опасные объекты (ВОП) в режиме реального времени и отображать их на экране для оператора. Основная цель проекта - помощь оператору и снижение риска пропустить ВОП при подготовке сырья (лома).
 
## Исходные данные
 
Заказчик, компания ООО «ПМХ-Втормет», предоставила датасет с изображениями предметов походящие под ВОП (взрыво опасные предметы). Далее по тексту -ВОП. 
Ссылки на датасет
https://disk.yandex.ru/d/YRVOTHsRD5m3BQ
https://disk.yandex.ru/d/zMnHfrk1f2AAmg

## Ход работ 

### 1. Анализ исходных данных

Для анализа исходных данных было предложено ознакомиться с изображениями и сформировать группы ВОП по отличительным признакам разбив их на классы для дальнейшей разметки.
После анализа предложено:
Поискать в открытых источниках похожие датасэты (Roboflow, Kaggle и пр.)
Найти в открытых источних картинки подходящие под ВОП и сформировать дополнительный датасет.
В итоге сбора информации, получили предварительный датасет, который в последующем в проекте дополняли изображениями по не достающим классам
Двигатели и трансмиссии - class: 0			            530 шт.	- Двигатели внутреннего сгорания; - Автомобильные коробки передач								
												
Аккумуляторы и ёмкости с жидкостями - class: 1			561	шт. - Автомобильные аккумуляторы; - Масляные баки; - Емкости с моторным маслом; - Топливные баки; 
                                                                - Канистры; - Емкости с химическими веществами								
												
Баллоны, гидроцилиндры, фильтры - class: 2			    1077 шт.- Баллоны с горючим газом; - Огнетушители; - Баллоны со сжатым воздухом; 
                                                                 - Домкраты с баллонами;  Гидроцилиндры и пневмоцилиндры;
                                                                 - Масляные фильтры 								
												
Радиаторы - class: 3			                        542 шт.	- Масляные трансформаторные радиаторы; - Радиаторы отопления водяной


### 2. Предобработка изображений

Собра итоговый датасэт: распределены изображения по папкам патчам, проверено что нет повторяющихся названий изображений, переименованы все изображения в единый формат nnnnnn.jpg. Ресайз полученных изображений в 640*640 
Мною была разработана программа, которая автоматически делает вышеуказанные функции.

### 3. Разметка

В CVAT каждым участником стажировки были размечены ориентировочно по 400 изображений

### 4. Проверка размеченных данных
 	
Цель проверить в любой программе для разметки наш размеченный датасэт DATASET_RAZMETKA на предмет:
- правильности указания классов
- разметки на изображениях всех необходимых объектов;
- отсутсвия в размеченных объектах не целевых классов.

Мною написан скрипт, который пробегается по папкам с разными версиями аннотаций в листе Сводная таблица для разметки датасетаи сверяет есть ли там отличия по содержанию, в случае выявления отличий отрисовывает картинки с разметкой и лейблами классов. 

### 7. Стратификационное разделение данных на train и val выборки

Разработана программа `Dmitry_Kravchenko/Stratific`.
Программа предназначена для анализа, проверки согласованности датасета, 
получения графика распределения классов в датасете и стратификационного разделения на train и val выборки. Полное описание и работы программы есть в файле README 

<img src="Dmitry_Kravchenko/Stratific/combined_distribution_plots.png" width="900">

### 8. Аугментация данных на train и val выборках

Разработана программа `Dmitry_Kravchenko/albumentations`.
Аугментация данных позволяет создать дополнительные вариации изображений и аннотаций, что помогает модели лучше обобщать и быть устойчивой к различным изменениям в данных, таким как освещение, повороты, шумы и другие эффекты. Полное описание и работы программы есть в файле README 

<img src="Dmitry_Kravchenko/albumentations/comparison_images.png" width="900">

### 9. Аугментация данных (создание мозаик)

Разработана программа `Dmitry_Kravchenko/Mosaic`.
Этот проект реализует создание мозаичных изображений для балансировки классов в датасетах, в которых изображения содержат несколько объектов разных классов. Основной задачей является обеспечение сбалансированного представления классов в датасете с помощью генерации мозаичных изображений. Полное описание и работы программы есть в файле README 

<img src="Dmitry_Kravchenko/Mosaic/Train.png" width="900">
<img src="Dmitry_Kravchenko/Mosaic/Valid.png" width="900">
<img src="Dmitry_Kravchenko/Mosaic/BB.png" width="900">
<img src="Dmitry_Kravchenko/Mosaic/mosaic.png" width="900">

### 10. Обучение моделей
Провел серию СРАВНИМЫХ экспериментов (25 шт). Результаты заносил в таблицу экспериментов 
`https://docs.google.com/spreadsheets/d/1kITmTxFs0wIV2mpYqvlF38ngY9xfTViX/edit?gid=25754079#gid=25754079`
Обучал сеть на YOLOv8n, YOLOv8m, YOLOv10m 
Эксперименты проводились со стратификацией, с аугментацией, с добавлением мозаики (8х8, 16х16)
Лучшие показатели остаются достигнутыми в exp022 (mAP 50 -95 составляет 0,701) - подбирались гиперпараметры при помощи библиотеки optuna
При добавлении в обучение изображений с мозаикой 8х8 метрика mAP 50 -95 падала до 0,627, но лучше детектировала классы на тестовом видео. При добавлени изображений с мозаикой 16х16 начало появляться много ложных срабатываний на тестовом видео.

##### Представлены результаты обучения моделей:
<img src="Dmitry_Kravchenko/yolov8/results.png" width="900">
<img src="Dmitry_Kravchenko/yolov8/val_batch1_labels.jpg" width="900">
<table>
  <tr>
    <td><img src="Dmitry_Kravchenko/yolov8/mosaic_plus_yolo/results.png" width="400"></td>
    </tr>
</table>

### 11. Выводы

Необходимо тщательно поработать с данными датасета, подчистить от выбросов, увеличить данные, отработать возможность проверки разметки
Необходимо проести еще серию СРАВНИМЫХ экспериментов, с включением изображений с разными количествами мозаик, использование других моделей таких как YOLOv10m, YOLO-NAS.
